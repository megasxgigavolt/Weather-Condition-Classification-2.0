version: 0.2

phases:
  pre_build:
    commands:
      - |
        set -eu
        echo "==> Resolve account and repo"
        ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
        REPO_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${IMAGE_REPO_NAME}"
        echo "==> Using REPO_URI: ${REPO_URI}"
        echo "==> Login to ECR"
        aws ecr get-login-password --region "${AWS_DEFAULT_REGION}" \
          | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"

  build:
    commands:
      - |
        set -eu
        echo "==> Build started on $(date)"
        docker build -t "${IMAGE_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION}" .
        docker tag "${IMAGE_REPO_NAME}:${CODEBUILD_RESOLVED_SOURCE_VERSION}" \
          "${REPO_URI}:${CODEBUILD_RESOLVED_SOURCE_VERSION}"

  post_build:
    commands:
      - |
        set -eu
        echo "==> Pushing image…"
        docker push "${REPO_URI}:${CODEBUILD_RESOLVED_SOURCE_VERSION}"
        echo "==> Writing Dockerrun.aws.json…"
        cat > Dockerrun.aws.json <<JSON
        {
          "AWSEBDockerrunVersion": "1",
          "Image": { "Name": "${REPO_URI}:${CODEBUILD_RESOLVED_SOURCE_VERSION}", "Update": "true" },
          "Ports": [ { "ContainerPort": "8080" } ]
        }
        JSON

artifacts:
  files:
    - Dockerrun.aws.json
